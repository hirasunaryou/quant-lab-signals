# 04. 戦略設計とリスク管理（手動売買向け・研究グレード）

Notebook:
- [`notebooks/11_position_sizing_and_costs.ipynb`](../notebooks/11_position_sizing_and_costs.ipynb)
- [`notebooks/12_strategy_report.ipynb`](../notebooks/12_strategy_report.ipynb)

> ⚠️ 教育目的の研究ノートです。投資助言ではありません。  
> 本フェーズでは**実ブローカー発注を実装しません**。シグナル検証と運用設計を分離します。

## 1) ポジションサイズの基本

手動売買でも、まず「方向（買い/売り/様子見）」と「サイズ（何株・何ロット）」を分けて考えると、判断の一貫性が上がります。

### 固定数量（Fixed 1 Unit）

- 例: シグナルが BUY のとき常に 1 単位だけ持つ
- 長所: 実装・理解が簡単
- 短所: ボラティリティが高い局面で相対的にリスクが大きくなりやすい

### ボラティリティ・ターゲティング（ATRベースの発想）

- ATR（Average True Range）で「最近の価格変動の荒さ」を推定し、荒い相場ではサイズを縮小、穏やかな相場では拡大する
- 直感式（概念）:

\[
\text{weight}_t \propto \frac{\sigma^*}{\mathrm{ATR}_t / \mathrm{Close}_t}
\]

- \(\sigma^*\): 目標の日次変動率（例: 1%）
- 実運用では上限レバレッジ・最小売買単位・流動性制約でクリップする

## 2) 主要リスク指標

### 最大ドローダウン（Max Drawdown）

- 過去ピークからの下落率の最悪値
- 「どれだけ資産が沈みうるか」を直感的に示す

### ボラティリティ（Volatility）

- 収益率の標準偏差（年率換算することが多い）
- 期待リターンだけでなく、揺れの大きさも同時に確認する

### 売買回転率（Turnover）

- ポジション変化量の累積（\(\sum |w_t - w_{t-1}|\)）
- コスト感応度の近似として重要

## 3) 取引コストとスリッページ

研究段階ではまず単純モデルで十分です。

- 手数料（fee）: `fee_bps * |Δposition|`
- スリッページ（slippage）: `slippage_bps * |Δposition|`
- 合計コストを日次リターンから差し引く

\[
r^{net}_t = r^{gross}_t - \frac{(\mathrm{fee\_bps} + \mathrm{slip\_bps})\cdot |\Delta w_t|}{10000}
\]

最初に粗い仮定で「利益の何割がコストで消えるか」を見るだけでも、過剰売買の検知に役立ちます。

## 4) 実行分離: Signal と Executor

本プロジェクトは以下の境界を明確にします。

- **Signal Layer（研究）**: データ取得、特徴量、シグナル、バックテスト、レポート
- **Executor Layer（運用）**: 注文生成、約定管理、再送、障害時の保護

本フェーズでは Signal Layer を主対象にし、Executor は将来拡張の設計のみ扱います。
まずは**ペーパートレード**（通知・記録・振り返り）で運用習熟する方針です。

## 5) アプリ想定の手動売買・日次ルーチン

1. 朝または前場前
   - 前日までの戦略レポート確認（勝率、DD、直近シグナル頻度）
2. 引け後
   - 最新データでシグナル更新
   - BUY/SELL のみ通知候補を生成（HOLD は通知しない）
3. 手動執行
   - ルールに沿って数量を決定（固定 or ATRターゲット）
   - 実際の約定価格をログ化
4. 週次レビュー
   - コスト込み成績、ワーストトレード窓、レジーム別失敗傾向を確認

## 6) 学習時の着眼点

- リターン改善だけでなく、DD・turnover の悪化を同時にチェックする
- 取引コストを入れると優位性が消えるルールは、実運用で脆弱
- 1銘柄で有効でも、レジームが変わると急に崩れることがある

---

次に進むときは、Notebook 11 でサイズとコスト感応度を確認し、Notebook 12 で「失敗する場面」を先に把握してからモバイル通知仕様へ落とし込むのがおすすめです。
