# ルール診断と理論駆動の改善（EMAクロス戦略）

対応ノートブック:
- `notebooks/07_rule_ablation_study.ipynb`
- `notebooks/08_parameter_sweep.ipynb`

## 目的

EMAクロスのようなシンプルルールは、実装が容易で再現性も高い一方、
**市場状態（regime）によって性能が大きく変わる** という課題があります。
この資料では、失敗モードを理論的に整理し、改善案を **アブレーション（要素分解比較）** で検証する流れをまとめます。

---

## 1) EMAクロスの代表的な失敗モード

### A. レンジ相場での whipsaw（ダマし）

- 価格が狭いレンジ内で往復すると、EMAの差分が 0 付近を行き来しやすくなります。
- その結果、`BUY -> SELL -> BUY ...` の反転が短期間で連発し、
  小さな損失やコストが積み上がる傾向があります。

### B. トレンド相場での lag（遅れ）

- EMAは平滑化指標なので、急なトレンド転換に対して反応が遅れます。
- シグナル発生時にはすでに値動きの一部が進んでおり、
  利益取りこぼしや、天井・底付近での逆行を招くことがあります。

---

## 2) なぜレジームフィルタが効くのか

レジームフィルタは、
**「今はトレンドを追うべき局面か？」** を先に判定する仕組みです。

- 例: ATRが一定閾値より高いときだけシグナルを有効化。
- 期待効果:
  - 低ボラ・レンジ局面のノイズ取引を減らす（whipsaw抑制）
  - 高ボラ局面でトレンドフォローの機会を残す

重要なのは、フィルタを追加したときに
**売買回数が減っただけなのか、1トレード当たりの質が改善したのか** を分けて見ることです。

---

## 3) Hit Rate 以外で見るべき評価指標

勝率（Hit Rate）だけでは戦略の良し悪しは判断できません。
以下をセットで確認します。

1. **Expectancy（期待値）**
   - 1トレードあたり平均リターン。
   - 勝率が低くても、平均利益が平均損失を十分上回ればプラスになり得ます。

2. **Average Win / Average Loss**
   - 利益トレードと損失トレードの平均幅。
   - 損小利大か、利小損大かを明確化できます。

3. **Drawdown（ドローダウン）**
   - 累積損益のピークからの落ち込み。
   - 実運用での心理的・資金管理上の難易度に直結します。

4. **Turnover（売買回転率）**
   - ポジション変化の頻度。
   - 手数料・スリッページ影響の感度を把握するために必要です。

---

## 4) アブレーション研究の進め方（with / without filter）

「どの要素が効いたのか」を見分けるために、
次のように **1要素ずつ** 比較します。

- Baseline: EMAクロスのみ
- +ATRレジーム
- +トレンド強度フィルタ（例: `|EMA_fast - EMA_slow| / ATR`）
- +クールダウン（シグナル後N日間は新規エントリしない）

ポイント:
- 同じデータ期間・同じ実現リターン定義で比較
- シードや前処理を固定して再現性を確保
- 「性能向上」と「取引頻度低下」を切り分けて解釈

---

## 5) ルックアヘッドバイアス（Look-ahead Bias）回避

最重要ルール:

- シグナルは **t時点までの情報** で作る
- リターンは **t+1で実現** するものとして評価する

実装上の定石:
- `position_t` をシグナルで作る
- `return_{t->t+1}` と掛け合わせる
- 同日終値でシグナルを見て同日終値で約定した前提にしない

ノートブック `07` / `08` では、この整合性を保ったシンプル実装を採用しています。

---

## まとめ

- EMAクロスの弱点（whipsaw / lag）を先に理解すると、改善案の方向性が明確になります。
- レジーム・強度・クールダウンの3系統は、ノイズ抑制と信号品質改善の典型手段です。
- 勝率だけでなく expectancy / drawdown / turnover を併用して評価しましょう。
- 研究段階では、アブレーションとパラメータスイープで「効く理由」を説明できることが重要です。
